// Code generated by goa v3.14.1, DO NOT EDIT.
//
// Zerolog logger implementation
//
// Command:
// $ goa gen apisvr/design -o ./services

package log

import (
	"fmt"
	"io"
	"os"
	"regexp"
	"time"

	"github.com/rs/zerolog"
)

// Logger is an adapted zerologger
type Logger struct {
	*zerolog.Logger
}

// New creates a new zerologger
func New(serviceName string, isDebug bool) *Logger {
	logLevel := zerolog.InfoLevel
	if isDebug {
		logLevel = zerolog.DebugLevel
	}
	zerolog.SetGlobalLevel(logLevel)
	var output io.Writer
	useConsoleWriter := regexp.MustCompile(`(?i)^(?:1|true|on|yes)$`).MatchString(os.Getenv("LOG_CONSOLE_WRITER"))
	if useConsoleWriter {
		output = zerolog.ConsoleWriter{Out: os.Stderr, TimeFormat: time.RFC3339}
	} else {
		output = os.Stderr
	}
	logger := zerolog.New(output).With().Timestamp().Str("service", serviceName).Logger()
	return &Logger{&logger}
}

// Log is called by the log middleware to log HTTP requests key values
func (logger *Logger) Log(keyvals ...interface{}) error {
	fields := FormatFields(keyvals)
	logger.Info().Fields(fields).Msgf("HTTP Request")
	return nil
}

// formatFields formats input keyvals
// ref: https://github.com/goadesign/goa/blob/v1/logging/logrus/adapter.go#L64
func FormatFields(keyvals []interface{}) map[string]interface{} {
	n := (len(keyvals) + 1) / 2
	res := make(map[string]interface{}, n)
	for i := 0; i < len(keyvals); i += 2 {
		k := keyvals[i]
		var v interface{}
		if i+1 < len(keyvals) {
			v = keyvals[i+1]
		}
		res[fmt.Sprintf("%v", k)] = v
	}
	return res
}
